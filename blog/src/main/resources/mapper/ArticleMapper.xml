<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shiyi.mapper.ArticleMapper">

    <select id="selectRecordPage" resultType="com.shiyi.dto.ArticleListDTO">
        select a.*,b.name as categoryName,group_concat(d.name separator ',') as tagNames from b_article a left join (select name,id from b_category) b on a.category_id=b.id
        left join  (select article_id,tag_id from b_article_tag) c on a.id=c.article_id
            left join (select id,name from b_tags) d on c.tag_id=d.id
        <where>
            <if test="param.title != null and param.title != ''">
                a.title like concat('%',#{param.title},'%')
            </if>
             <if test="param.categoryId != null and param.categoryId != ''">
                 and a.category_id=#{param.categoryId}
            </if>
            <if test="param.isPublish != null and param.isPublish != ''">
                 and a.is_publish=#{param.isPublish}
            </if>
            <if test="param.tagId != null and param.tagId != ''">
                and c.tag_id=#{param.tagId}
            </if>
        </where>
        GROUP BY a.id order by a.is_stick desc
    </select>

    <select id="contribute" resultType="com.shiyi.dto.ContributeDTO">
        select count,date from
        (SELECT
            count(id) as count,
            DATE_FORMAT(create_time,'%Y-%m-%d') as date,
            create_time
        FROM
            `b_article`
        where DATE_FORMAT(create_time,'%Y-%m-%d') between #{lastTime} and #{nowTime}
        GROUP BY
            `create_time`) AS blog
        ORDER BY blog.create_time ASC
    </select>
    <select id="listRecommendArticles" resultType="com.shiyi.dto.ArticleRecoDTO">
        SELECT
            id,
            title,
            avatar,
            create_time
        FROM
            (
                SELECT DISTINCT
                    article_id
                FROM
                        ( SELECT tag_id FROM b_article_tag WHERE article_id = #{articleId} ) t
                            JOIN b_article_tag t1 ON t.tag_id = t1.tag_id
                WHERE
                    article_id != #{articleId}
            ) t2
                JOIN b_article a ON t2.article_id = a.id
        WHERE a.is_publish = 1
        ORDER BY
            is_stick DESC,id DESC
            LIMIT 6
    </select>

    <select id="getNextOrLastArticle" resultType="com.shiyi.dto.ArticleRecoDTO">
        select id,title,avatar from b_article where is_publish=#{publish}
        <choose>
            <when test="type == 0">
              and id &lt; #{id} order by id desc
            </when>
            <otherwise>
                and id &gt; #{id} order by id Asc
            </otherwise>
        </choose>
         limit 1
    </select>
    <select id="getNewArticles" resultType="com.shiyi.dto.ArticleRecoDTO">
        select id,title,avatar,create_time from b_article where is_publish=#{publish} and id != #{id}
        order by id desc limit 5
    </select>

    <select id="info" resultType="com.shiyi.vo.ArticleVO">
        select a.id,a.title,a.avatar,a.summary,a.quantity,a.content,a.content_md,a.is_secret,a.is_stick,a.is_publish,a.is_original,a.original_url,
               a.remark,a.create_time,a.keywords,a.update_time,b.name as categoryName from b_article a
                   LEFT JOIN (SELECT id,name from b_category) b on a.category_id=b.id where a.id=#{id}
    </select>
</mapper>
